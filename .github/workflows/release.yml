name: Release Manager

on:
  push:
    branches:
      - "main"
      - "master"
    tags:
      - "v*"

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Build Plugin Archive
        run: |
          chmod +x build.sh
          ./build.sh

      # Scenario 1: Rolling Release for Main/Master
      - name: Update Latest Release
        if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
        uses: ncipollo/release-action@v1
        with:
          tag: latest
          name: Latest Build
          body: "Rolling release for the latest changes on ${{ github.ref_name }}."
          allowUpdates: true
          removeArtifacts: true
          replacesArtifacts: true
          artifacts: "wp-external-media.zip"
          prerelease: true

      # Scenario 2: Versioned Release for Tags
      - name: Create Versioned Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: ncipollo/release-action@v1
        with:
          allowUpdates: true
          artifacts: "wp-external-media.zip"
          # tag defaults to github.ref_name (e.g., v1.0.0)
          # name defaults to tag name
