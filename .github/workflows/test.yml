name: End-to-End Tests

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]
  workflow_dispatch:

jobs:
  e2e-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install Docker Compose
        run: |
          # Docker Compose is typically pre-installed on ubuntu-latest, 
          # but we ensure the environment is ready.
          docker-compose version

      - name: Make Scripts Executable
        run: chmod +x test/run_test.sh test/setup.sh

      - name: Run E2E Tests
        run: ./test/run_test.sh

      - name: Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-test-report
          path: test/test-reports/*.xml
          if-no-files-found: ignore

      - name: Publish Test Report
        uses: mikepenz/action-junit-report@v4
        if: always()
        with:
          report_paths: 'test/test-reports/*.xml'
